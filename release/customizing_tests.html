
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Customizing Patcher and TestCase &#8212; pyfakefs 3.6dev documentation</title>
    <link rel="stylesheet" href="_static/pyfakefs.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 3.6dev documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="customizing-patcher-and-testcase">
<span id="customizing-tests"></span><h1>Customizing Patcher and TestCase<a class="headerlink" href="#customizing-patcher-and-testcase" title="Permalink to this headline">¶</a></h1>
<p>Both <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.Patcher</span></code> and <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.TestCase</span></code>
provide a few arguments to handle cases where patching does not work out of
the box.
In case of <code class="docutils literal notranslate"><span class="pre">fake_filesystem_unittest.TestCase</span></code>, these arguments can either
be set in the TestCase instance initialization, or passed to <code class="docutils literal notranslate"><span class="pre">setUpPyfakefs()</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you need these arguments in <code class="docutils literal notranslate"><span class="pre">PyTest</span></code>, you must
use <code class="docutils literal notranslate"><span class="pre">Patcher</span></code> directly instead of the <code class="docutils literal notranslate"><span class="pre">fs</span></code> fixture. Alternatively,
you can add your own fixture with the needed parameters.</p>
<p class="last">An example for both approaches can be found in
<a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/blob/master/pyfakefs/tests/pytest/pytest_fixture_test.py">pytest_fixture_test.py</a>
with the example fixture in <a class="reference external" href="https://github.com/jmcgeheeiv/pyfakefs/blob/master/pyfakefs/tests/pytest/conftest.py">conftest.py</a>.
We advice to use this example fixture code as a template for your customized
pytest plugins.</p>
</div>
<div class="section" id="modules-to-reload">
<h2>modules_to_reload<a class="headerlink" href="#modules-to-reload" title="Permalink to this headline">¶</a></h2>
<p>Pyfakefs patches modules that are imported before starting the test by
finding and replacing file system modules in all loaded modules at test
initialization time.
This allows to automatically patch file system related modules that are:</p>
<ul class="simple">
<li>imported directly, for example:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib.Path</span>
</pre></div>
</div>
<ul class="simple">
<li>imported as another name:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">my_os</span>
</pre></div>
</div>
<ul class="simple">
<li>imported using one of these two specially handled statements:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
</pre></div>
</div>
<p>Additionally, functions from file system related modules are patched
automatically if imported like:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">stat</span>
</pre></div>
</div>
<p>This also works if importing the functions as another name:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">exists</span> <span class="k">as</span> <span class="n">my_exists</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">io_open</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">bltn_open</span>
</pre></div>
</div>
<p>There are a few cases where automatic patching does not work. We know of two
specific cases where this is the case:</p>
<ul class="simple">
<li>initializing global variables:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/example_home&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">path</span></code> will hold the real file system path inside the test.</p>
<ul class="simple">
<li>initializing a default argument:</li>
</ul>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">check_if_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file_exists</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">file_exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">file_exists</span></code> will not be patched in the test.</p>
<p>To get these cases to work as expected under test, the respective modules
containing the code shall be added to the <code class="docutils literal notranslate"><span class="pre">modules_to_reload</span></code> argument (a
module list).
The passed modules will be reloaded, thus allowing pyfakefs to patch them
dynamically. All modules loaded after the initial patching described above
will be patched using this second mechanism.</p>
<p>Given tat the example code shown above is located in the file <code class="docutils literal notranslate"><span class="pre">example/sut.py</span></code>,
the following code will work:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># example using unittest</span>
<span class="k">class</span> <span class="nc">ReloadModuleTest</span><span class="p">(</span><span class="n">fake_filesystem_unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUpPyfakefs</span><span class="p">(</span><span class="n">modules_to_reload</span><span class="o">=</span><span class="p">[</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

<span class="c1"># example using Patcher</span>
<span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">Patcher</span><span class="p">()</span> <span class="k">as</span> <span class="n">patcher</span><span class="p">:</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
      <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
<p>Example using pytest:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># conftest.py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">example</span> <span class="k">import</span> <span class="n">sut</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fs_reload_sut</span><span class="p">():</span>
    <span class="n">patcher</span> <span class="o">=</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">modules_to_reload</span><span class="o">=</span><span class="p">[</span><span class="n">sut</span><span class="p">])</span>
    <span class="n">patcher</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
    <span class="n">linecache</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">original_open</span>
    <span class="n">tokenize</span><span class="o">.</span><span class="n">_builtin_open</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">original_open</span>
    <span class="k">yield</span> <span class="n">patcher</span><span class="o">.</span><span class="n">fs</span>
    <span class="n">patcher</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

<span class="c1"># test_code.py</span>
<span class="o">...</span>
<span class="k">def</span> <span class="nf">test_path_exists</span><span class="p">(</span><span class="n">fs_reload_sut</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/foo/bar&#39;</span>
    <span class="n">fs_reload_sut</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">example</span><span class="o">.</span><span class="n">sut</span><span class="o">.</span><span class="n">check_if_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="modules-to-patch">
<h2>modules_to_patch<a class="headerlink" href="#modules-to-patch" title="Permalink to this headline">¶</a></h2>
<p>Sometimes there are file system modules in other packages that are not
patched in standard pyfakefs. To allow patching such modules,
<code class="docutils literal notranslate"><span class="pre">modules_to_patch</span></code> can be used by adding a fake module implementation for
a module name. The argument is a dictionary of fake modules mapped to the
names to be faked.</p>
<p>This mechanism is used in pyfakefs itself to patch the external modules
<cite>pathlib2</cite> and <cite>scandir</cite> if present, and the following example shows how to
fake a module in Django that uses OS file system functions:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeLocks</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;django.core.files.locks uses low level OS functions, fake it.&quot;&quot;&quot;</span>
<span class="n">_locks_module</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">locks</span>

<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Each fake module expects the fake file system as an __init__ parameter.&quot;&quot;&quot;</span>
    <span class="c1"># for a real example, fs can be saved here and used in the implementation</span>
    <span class="k">pass</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_locks_module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">with</span> <span class="n">Patcher</span><span class="p">(</span><span class="n">modules_to_patch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;django.core.files.locks&#39;</span><span class="p">:</span> <span class="n">FakeLocks</span><span class="p">}):</span>
    <span class="n">test_django_stuff</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-skip-names">
<h2>additional_skip_names<a class="headerlink" href="#additional-skip-names" title="Permalink to this headline">¶</a></h2>
<p>This may be used to add modules that shall not be patched. This is mostly
used to avoid patching the Python file system modules themselves, but may be
helpful in some special situations. There is also the global
variable <code class="docutils literal notranslate"><span class="pre">Patcher.SKIPNAMES</span></code> that can be extended for that purpose, though
this seldom should be needed (except for own pytest plugins, as shown in
the example mentioned above)</p>
</div>
<div class="section" id="use-dynamic-patch">
<h2>use_dynamic_patch<a class="headerlink" href="#use-dynamic-patch" title="Permalink to this headline">¶</a></h2>
<p>If <code class="docutils literal notranslate"><span class="pre">True</span></code> (the default), dynamic patching after setup is used (for example
for modules loaded locally inside of functions).
Can be switched off if it causes unwanted side effects. This parameter will
probably removed in the future - it has been added while dynamic patching
was an experimental feature.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Customizing Patcher and TestCase</a><ul>
<li><a class="reference internal" href="#modules-to-reload">modules_to_reload</a></li>
<li><a class="reference internal" href="#modules-to-patch">modules_to_patch</a></li>
<li><a class="reference internal" href="#additional-skip-names">additional_skip_names</a></li>
<li><a class="reference internal" href="#use-dynamic-patch">use_dynamic_patch</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/customizing_tests.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pyfakefs 3.6dev documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009 Google Inc. All Rights Reserved.
© Copyright 2014 Altera Corporation. All Rights Reserved.
© Copyright 2014-2018 John McGehee.
      Last updated on Dec 06, 2018.
    </div>
  </body>
</html>